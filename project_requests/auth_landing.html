<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Sign in...</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
</head>
<body>
  <div id="message">Signing you in&#8230;</div>

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';

    // Replace these with your project values
    const SUPABASE_URL = 'https://svzlfpqdarhwfyznrhyg.supabase.co';
    const SUPABASE_ANON_KEY = 
          'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InN2emxmcHFkYXJod2Z5em5yaHlnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM3NDgzMDUsImV4cCI6MjA3OTMyNDMwNX0.oMEgRkPnoE21HCN4ETNdkyjljawJe_dSYKppJnLnL6w';

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
      // Optional: adjust auto-refresh/session persistance if needed
      auth: {
        persistSession: true,
        detectSessionInUrl: false // we'll handle it explicitly
      }
    });

    const messageEl = document.getElementById('message');

    (async function finishAuth() {
      try {
        // Parse tokens from the URL hash (fragment)
        const hashParams = new URLSearchParams(window.location.hash.replace(/^#/, ''));
        const accessToken = hashParams.get('access_token');
        const refreshToken = hashParams.get('refresh_token');
        const errorParam = hashParams.get('error');
        const errorDescription = hashParams.get('error_description');

        // Check for errors in the URL
        if (errorParam) {
          console.error('Auth error from URL:', errorParam, errorDescription);
          messageEl.textContent = 'Sign-in failed: ' + (errorDescription || errorParam);
          return;
        }

        // If no tokens, check if there's already a session
        if (!accessToken || !refreshToken) {
          const { data: { session }, error } = await supabase.auth.getSession();
          if (session) {
            // Already have a session, redirect
            const urlParams = new URLSearchParams(window.location.search);
            let redirectTo = urlParams.get('redirect_to') || hashParams.get('redirect_to') || '/';
            setTimeout(() => {
              window.location.replace(redirectTo);
            }, 200);
            messageEl.textContent = 'Already signed in. Redirecting&#8230;';
            return;
          }
          messageEl.textContent = 'No authentication tokens found. Please try signing in again.';
          return;
        }

        // Use setSession to establish the session with the tokens
        const { data, error } = await supabase.auth.setSession({
          access_token: accessToken,
          refresh_token: refreshToken
        });

        if (error) {
          console.error('setSession error:', error);
          messageEl.textContent = 'Sign-in failed: ' + (error.message || 'unknown error');
          return;
        }

        // If we have a session, redirect to the original destination
        if (data?.session) {
          // Get redirect_to from query string or hash params
          const urlParams = new URLSearchParams(window.location.search);
          let redirectTo = urlParams.get('redirect_to');

          if (!redirectTo) {
            redirectTo = hashParams.get('redirect_to');
          }

          // Fallback to a default path
          if (!redirectTo) redirectTo = '/site/SPageNavigator/project_requests/projects_list.html';

          // Small delay to let session persist to storage
          setTimeout(() => {
            window.location.replace(redirectTo);
          }, 200);
          messageEl.textContent = 'Signed in. Redirecting&#8230;';
          return;
        }

        // No session and no error &#8212; show a fallback message
        messageEl.textContent = 'No session created. Please try signing in again.';
      } catch (err) {
        console.error('Unexpected error finishing auth:', err);
        messageEl.textContent = 'Unexpected error. See console for details.';
      }
    })();
  </script>
</body>
</html>